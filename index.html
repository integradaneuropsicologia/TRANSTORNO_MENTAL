<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TRANSTORNO_MENTAL</title>
<style>
  /* TEMA CLARO (padr√£o) */
  :root{
    --bg:#f3f4f6;
    --card:#ffffff;
    --line:#d1d5db;
    --text:#111827;
    --muted:#6b7280;
    --pri:#4f46e5;
    --ok:#16a34a;
    --err:#dc2626;

    --info-bg:#f9fafb;
    --q-bg:#f9fafb;
    --field-bg:#ffffff;
    --legend-bg:#eef2ff;

    --okbox-bg:#ecfdf3;
    --okbox-border:#bbf7d0;
    --okbox-text:#166534;

    --errbox-bg:#fef2f2;
    --errbox-border:#fecaca;
    --errbox-text:#7f1d1d;

    --warnbox-bg:#fffbeb;
    --warnbox-border:#facc15;
    --warnbox-text:#78350f;
  }

  /* TEMA ESCURO */
  :root[data-theme="dark"]{
    --bg:#0f172a;
    --card:#111827;
    --line:#1f2937;
    --text:#e5e7eb;
    --muted:#94a3b8;
    --pri:#4f46e5;
    --ok:#22c55e;
    --err:#ef4444;

    --info-bg:#0b1220;
    --q-bg:#0b1220;
    --field-bg:#0a0f1c;
    --legend-bg:#0b1220;

    --okbox-bg:#052e1a;
    --okbox-border:#114d2a;
    --okbox-text:#b3f7c1;

    --errbox-bg:#3b0d0d;
    --errbox-border:#5b1919;
    --errbox-text:#ffd0d0;

    --warnbox-bg:#3a2903;
    --warnbox-border:#5c4307;
    --warnbox-text:#ffe6b0;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto
  }
  .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px}
  h1{margin:0 0 6px;font-size:1.35rem}
  .muted{color:var(--muted)}

  .header{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:12px;
    flex-wrap:wrap;
  }

  .grid-info{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:12px 0 6px}
  @media(max-width:720px){.grid-info{grid-template-columns:1fr}}

  .info{
    background:var(--info-bg);
    border:1px solid var(--line);
    border-radius:10px;
    padding:10px
  }
  .info b{display:block;margin-bottom:4px}

  .q{
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px;
    background:var(--q-bg);
    margin-bottom:10px
  }
  .q h3{margin:0 0 8px;font-size:1rem}

  textarea{
    width:100%;
    min-height:80px;
    resize:vertical;
    border-radius:10px;
    border:1px solid var(--line);
    background:var(--field-bg);
    color:var(--text);
    padding:10px
  }

  input.field-input{
  width:100%;
  border-radius:10px;
  border:1px solid var(--line);
  background:var(--field-bg);
  color:var(--text);
  padding:8px 10px;
}

/* o estilo do ‚Äúpontinho‚Äù vale tamb√©m para checkbox */
.opt input[type="radio"],
.opt input[type="checkbox"]{
  accent-color:var(--pri);
}


  .hint{font-size:.9rem;color:var(--muted);margin-bottom:8px}
  .opts{display:flex;flex-wrap:wrap;gap:10px}
  label.opt{display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--line);border-radius:10px;cursor:pointer}
  .opt input[type="radio"]{accent-color:var(--pri)}
  label.opt:has(input[type="radio"]:checked){
    background:var(--pri);
    border-color:var(--pri);
    color:#fff;
  }
  label.opt:has(input[type="radio"]:checked) span{
    color:#fff;
    font-weight:600;
  }

  .btn{
    display:inline-flex;
    align-items:center;
    gap:8px;
    background:var(--pri);
    border:none;
    color:#fff;
    padding:10px 14px;
    border-radius:10px;
    cursor:pointer;
    font-size:.9rem;
  }
  .btn.ok{background:var(--ok)}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  /* bot√£o de tema: estilo mais ‚Äúneutro‚Äù */
  .btn-toggle{
    background:transparent;
    color:var(--text);
    border:1px solid var(--line);
    padding:6px 10px;
  }

  .msg{margin:10px 0;padding:10px;border-radius:8px}
  .okbox{background:var(--okbox-bg);border:1px solid var(--okbox-border);color:var(--okbox-text)}
  .errbox{background:var(--errbox-bg);border:1px solid var(--errbox-border);color:var(--errbox-text)}
  .warnbox{background:var(--warnbox-bg);border:1px solid var(--warnbox-border);color:var(--warnbox-text)}

  .legend{
    background:var(--legend-bg);
    border:1px dashed var(--line);
    border-radius:10px;
    padding:10px;
    margin:6px 0 12px
  }

  .q.missing{
  border-color: var(--err);
  box-shadow: 0 0 0 1px var(--err);
}

</style>

</head>
<body>
<div class="wrap">
  <div class="header">
  <h1>TRANSTORNO_MENTAL</h1>
  <button id="themeToggle" type="button" class="btn btn-toggle">
    Modo escuro
  </button>
</div>

    
    <!-- Dados do paciente (por token) -->
    <div id="pacInfo" class="grid-info" style="display:none;"></div>

    <form id="form" style="margin-top:14px; display:none;">
      <div id="qs"></div>

      <div class="legend muted">Dica: responda livremente; o rascunho √© salvo automaticamente neste dispositivo.</div>

      <div style="margin-top:14px;display:flex;gap:8px;align-items:center">
        <button id="btnSubmit" class="btn ok" type="submit">Enviar formul√°rio</button>
        <div id="progress" class="muted"></div>
      </div>
      <div id="msg" class="msg" style="display:none"></div>
    </form>

    <div id="alert" class="msg" style="display:none"></div>
  </div>
</div>

<script>
// ======== CONFIG ========
// ======== TEMA CLARO/ESCURO ========
const THEME_KEY = "THEME_TRANSTORNO_MENTAL";

function applyTheme(theme){
  const root = document.documentElement;
  if (theme === "dark") {
    root.setAttribute("data-theme","dark");
  } else {
    root.removeAttribute("data-theme"); // volta pro claro
    theme = "light";
  }
  localStorage.setItem(THEME_KEY, theme);

  const btn = document.getElementById("themeToggle");
  if (btn) {
    btn.textContent = (theme === "dark") ? "Modo claro" : "Modo escuro";
  }
}

// inicializa tema e listener do bot√£o
(function initTheme(){
  const saved = localStorage.getItem(THEME_KEY) || "light";
  applyTheme(saved);

  const btn = document.getElementById("themeToggle");
  if (btn) {
    btn.addEventListener("click", () => {
      const current = document.documentElement.getAttribute("data-theme") === "dark" ? "dark" : "light";
      applyTheme(current === "dark" ? "light" : "dark");
    });
  }
})();



const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = { PATIENTS:"Patients", TOKENS:"LinkTokens", SCORES:"Scores_TRANSTORNO_MENTAL" };
const CODE = "TRANSTORNO_MENTAL";
const PORTAL_URL = "https://integradaneuropsicologia.github.io/formularios/";

// ======== HELPERS ========
const $ = s => document.querySelector(s);
const onlyDigits = s => (s||"").replace(/\D+/g,"");
const qs = k => new URLSearchParams(location.search).get(k) || "";
const AUTOSAVE_KEY = `${CODE}_${qs("token")||"no_token"}`;

function setBox(id, text, kind="ok"){ const el=$(id); if(!el) return;
  el.textContent=text; el.className="msg "+(kind==="ok"?"okbox":kind==="warn"?"warnbox":"errbox"); el.style.display="block";
}
function hideBox(id){ const el=$(id); if(el){ el.style.display="none"; el.textContent=""; } }
function maskCPF(cpf){ const d=onlyDigits(cpf||""); if(d.length!==11) return cpf||""; return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`; }
function fmtDateISO(iso){ if(!iso) return ""; const [y,m,d]=iso.split("-"); return (y&&m&&d)?`${d}/${m}/${y}`:iso; }
async function GET(url){ const r=await fetch(url); if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); }
async function POST(url, body){ const r=await fetch(url,{method:"POST",headers:{ "Content-Type":"application/json" },body:JSON.stringify(body)}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
async function PATCH(url, body){ const r=await fetch(url,{method:"PATCH",headers:{ "Content-Type":"application/json" },body:JSON.stringify(body)}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
async function sheetSearch(sheet, params){ const usp=new URLSearchParams(params); return GET(`${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`); }
async function sheetCreate(sheet, row){ return POST(`${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`, { data:[row] }); }
async function sheetPatchBy(sheet, column, value, data){ return PATCH(`${SHEETDB_BASE}/${encodeURIComponent(column)}/${encodeURIComponent(value)}?sheet=${encodeURIComponent(sheet)}`, { data }); }
function goPortalWithToken(){ const TOKEN=qs("token"); try{ const u=new URL(PORTAL_URL,location.href); u.searchParams.set("token",TOKEN); location.href=u.toString(); }catch(_){ const sep=PORTAL_URL.includes("?")?"&":"?"; location.href=PORTAL_URL+sep+"token="+encodeURIComponent(TOKEN); }}

// ======== PERGUNTAS ========
// Escalas padr√£o
const FREQ5   = ["Nunca","Raramente","√Äs vezes","Frequentemente","Quase sempre"];
const SEVER4  = ["N√£o","Leve","Moderada","Grave"];
const YESNO   = ["Sim","N√£o"];
const YNP     = ["Sim","N√£o","N√£o sei"];
const FREQ6   = ["Nunca","Raramente","√Äs vezes","Frequentemente","Quase sempre", "N√£o sei/N√£o se aplica"];

const QUESTIONS = [
 // ‚Äî‚Äî‚Äî HUMOR DEPRESSIVO ‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Humor ‚Äî Depressivo", text:"Humor deprimido (tristeza, vazio, desesperan√ßa)", options: FREQ5 },
  { type:"checkbox", section:"Humor ‚Äî Depressivo", text:"Perda de interesse/prazer (anedonia)", options: FREQ5 },
  { type:"checkbox", section:"Humor ‚Äî Depressivo", text:"Culpa excessiva/autoacusa√ß√£o", options: FREQ5 },
  { type:"checkbox", section:"Humor ‚Äî Depressivo", text:"Dificuldade de concentra√ß√£o/decis√£o", options: FREQ5 },
  { type:"checkbox", section:"Humor ‚Äî Depressivo", text:"Altera√ß√µes de sono/apetite/energia", options: FREQ5 },

  // ‚Äî‚Äî‚Äî MANIA/HIPOMANIA ‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Humor ‚Äî Mania/Hipomania", text:"Menor necessidade de sono por dias (sem sentir cansa√ßo)", options: FREQ5 },
  { type:"checkbox", section:"Humor ‚Äî Mania/Hipomania", text:"Humor elevado/irrit√°vel anormal", options: FREQ5 },
  { type:"checkbox", section:"Humor ‚Äî Mania/Hipomania", text:"Fala acelerada, fuga de ideias", options: FREQ5 },
  { type:"checkbox", section:"Humor ‚Äî Mania/Hipomania", text:"Grandiosidade/autoestima inflada", options: FREQ5 },
  { type:"checkbox", section:"Humor ‚Äî Mania/Hipomania", text:"Comportos de risco (gastos, sexo, dire√ß√£o/neg√≥cios)", options: FREQ5 },

  // ‚Äî‚Äî‚Äî ANSIEDADE (TAG/P√ÇNICO/AGORAFOBIA/SOCIAL) ‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Ansiedade ‚Äî N√∫cleo", text:"Preocupa√ß√£o excessiva dif√≠cil de controlar (rumina√ß√£o)", options: FREQ5 },
  { type:"checkbox", section:"Ansiedade ‚Äî N√∫cleo", text:"Sintomas f√≠sicos (taquicardia, tens√£o, sudorese, GI)", options: FREQ5 },
  { type:"checkbox", section:"Ansiedade ‚Äî P√¢nico", text:"Crises s√∫bitas com pico em minutos (ataques de p√¢nico)", options: YNP },
  { type:"checkbox", section:"Ansiedade ‚Äî Evita√ß√£o", text:"Evita lugares/situa√ß√µes por medo de passar mal/ser julgado", options: FREQ5 },

  // ‚Äî‚Äî‚Äî TRAUMA/ESTRESSORES ‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Trauma & Estressores", text:"Exposi√ß√£o a evento traum√°tico significativo", options: YNP },
  { type:"checkbox", section:"Trauma & Estressores", text:"Reexperi√™ncias (flashbacks/pesadelos/mal-estar a pistas)", options: FREQ5 },
  { type:"checkbox", section:"Trauma & Estressores", text:"Evita√ß√£o de lembran√ßas/locais/pessoas relacionadas", options: FREQ5 },
  { type:"checkbox", section:"Trauma & Estressores", text:"Hipervigil√¢ncia/irritabilidade/sobressalto exagerado", options: FREQ5 },

  // ‚Äî‚Äî‚Äî TOC & RELACIONADOS ‚Äî‚Äî‚Äî
  { type:"checkbox", section:"TOC & Relacionados", text:"Obsess√µes (pensamentos/impulsos intrusivos indesejados)", options: FREQ5 },
  { type:"checkbox", section:"TOC & Relacionados", text:"Compuls√µes/rituais para reduzir ansiedade", options: FREQ5 },
  { type:"checkbox", section:"TOC & Relacionados", text:"Tempo di√°rio gasto (soma de rituais/rumina√ß√£o)", options:["Nenhum","< 1 hora","1‚Äì3 horas","> 3 horas"] },
  { type:"checkbox", section:"TOC & Relacionados", text:"Insight sobre excesso/irracionalidade dos sintomas", options:["Bom/razo√°vel","Parcial","Ruim","Ausente (convic√ß√£o)"] },

  // ‚Äî‚Äî‚Äî PSICOSES ‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Psicose ‚Äî N√∫cleo", text:"Alucina√ß√µes (vozes/visuais/olfativas/t√°teis)", options: YNP },
  { type:"checkbox", section:"Psicose ‚Äî N√∫cleo", text:"Del√≠rios (persegui√ß√£o, refer√™ncia, grandeza, som√°tico)", options: YNP },
  { type:"checkbox", section:"Psicose ‚Äî Organiza√ß√£o", text:"Pensamento/linguagem desorganizados", options: FREQ5 },
  { type:"checkbox", section:"Psicose ‚Äî Curso", text:"Epis√≥dios ‚â• 1 m√™s e preju√≠zo funcional associado", options: YNP },

  // ‚Äî‚Äî‚Äî USO DE SUBST√ÇNCIAS ‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Subst√¢ncias", text:"Uso com preju√≠zo (trabalho, rela√ß√µes, sa√∫de) ‚Äî √°lcool", options: YNP },
  { type:"checkbox", section:"Subst√¢ncias", text:"Uso com preju√≠zo ‚Äî cannabis/estimulantes/sedativos", options: YNP },
  { type:"checkbox", section:"Subst√¢ncias", text:"Toler√¢ncia/abstin√™ncia/uso maior que o planejado", options: YNP },
  { type:"checkbox", section:"Subst√¢ncias", text:"Tentativas fracassadas de reduzir/parar", options: YNP },

  // ‚Äî‚Äî‚Äî ALIMENTA√á√ÉO & IMAGEM CORPORAL ‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Alimenta√ß√£o & Imagem", text:"Restri√ß√£o alimentar/medo intenso de engordar", options: FREQ5 },
  { type:"checkbox", section:"Alimenta√ß√£o & Imagem", text:"Epis√≥dios de compuls√£o alimentar", options: FREQ5 },
  { type:"checkbox", section:"Alimenta√ß√£o & Imagem", text:"Comportos compensat√≥rios (v√¥mitos, laxantes, exerc√≠cios excessivos)", options: YNP },
  { type:"checkbox", section:"Alimenta√ß√£o & Imagem", text:"Insatisfa√ß√£o intensa com a imagem corporal", options: FREQ5 },

  // ‚Äî‚Äî‚Äî SONO & RITMO ‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Sono & Ritmo", text:"Ins√¥nia (iniciar/manter) ou sono n√£o reparador", options: FREQ5 },
  { type:"checkbox", section:"Sono & Ritmo", text:"Hipersonia/sonol√™ncia diurna", options: FREQ5 },
  { type:"checkbox", section:"Sono & Ritmo", text:"Sinais de apneia/ronco/pausas respirat√≥rias", options: YNP },

  // ‚Äî‚Äî‚Äî NEURODESENVOLVIMENTO (ADULTO) ‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Neurodesenvolvimento (Adulto)", text:"Desaten√ß√£o (erros por descuido, perde objetos, 'time blindness')", options: FREQ5 },
  { type:"checkbox", section:"Neurodesenvolvimento (Adulto)", text:"Impulsividade/hiperatividade (fala/levanta/interrompe)", options: FREQ5 },
  { type:"checkbox", section:"Neurodesenvolvimento (Adulto)", text:"Dificuldades sociais desde cedo (pragm√°tica/rigidez/interesses restritos)", options: FREQ5 },
  { type:"checkbox", section:"Neurodesenvolvimento (Adulto)", text:"Sensibilidades sensoriais (som, luz, toque, texturas)", options: FREQ5 },

  // ‚Äî‚Äî‚Äî DISSOCIATIVOS ‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Dissociativos", text:"Despersonaliza√ß√£o/desrealiza√ß√£o", options: FREQ5 },
  { type:"checkbox", section:"Dissociativos", text:"Lacunas de mem√≥ria/apag√µes para eventos pessoais", options: YNP },
  { type:"checkbox", section:"Dissociativos", text:"'Partes' internas distintas/vozes internas com amn√©sia", options: YNP },

  // ‚Äî‚Äî‚Äî SOM√ÅTICOS & DOR ‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Som√°ticos & Dor", text:"M√∫ltiplos sintomas f√≠sicos sem explica√ß√£o cl√≠nica suficiente", options: FREQ5 },
  { type:"checkbox", section:"Som√°ticos & Dor", text:"Preocupa√ß√£o excessiva com sa√∫de/checagens repetidas", options: FREQ5 },
  { type:"checkbox", section:"Som√°ticos & Dor", text:"Evita atividades por medo de sintomas corporais", options: FREQ5 },

  // ‚Äî‚Äî‚Äî IMPULSO/CONDUTA ‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Impulso & Conduta", text:"Explos√µes desproporcionais (verbais/f√≠sicas)", options: FREQ5 },
  { type:"checkbox", section:"Impulso & Conduta", text:"Mentiras/roubos/viola√ß√£o de regras persistentes", options: FREQ5 },
  { type:"checkbox", section:"Impulso & Conduta", text:"Pouco remorso ap√≥s prejudicar algu√©m", options: FREQ5 },

  // ‚Äî‚Äî‚Äî NEUROCOGNITIVO ‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Neurocognitivo", text:"Esquecimentos recentes/repete perguntas", options: FREQ5 },
  { type:"checkbox", section:"Neurocognitivo", text:"Queda em tarefas instrumentais (finan√ßas, medica√ß√£o, rotas)", options: SEVER4 },
  { type:"checkbox", section:"Neurocognitivo", text:"Curso progressivo (meses/anos) percebido por terceiros", options: YNP },

  // ‚Äî‚Äî‚Äî PERSONALIDADE/TRA√áOS DUR√ÅVEIS ‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Personalidade (Tra√ßos)", text:"Padr√µes r√≠gidos e persistentes (anos) em v√°rios contextos", options: YNP },
  { type:"checkbox", section:"Personalidade (Tra√ßos)", text:"Conflitos interpessoais cr√¥nicos/rupturas recorrentes", options: FREQ5 },
  { type:"checkbox", section:"Personalidade (Tra√ßos)", text:"Dificuldades de autorregula√ß√£o (impulsos/emo√ß√µes)", options: SEVER4 },

  // ‚Äî‚Äî‚Äî DIFERENCIAL & EXCLUS√ïES ‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Diferencial & Exclus√µes", text:"Uso atual de subst√¢ncias/medica√ß√µes que alteram humor/sono/pensamento", options:["N√£o","√Ålcool","Cannabis","Estimulantes","Sedativos/ansiol√≠ticos","Corticoides","Outras"] },
  { type:"checkbox", section:"Diferencial & Exclus√µes", text:"Condi√ß√£o cl√≠nica (tireoide, B12, dor cr√¥nica, neurol√≥gica) explicando sintomas", options: YNP },
  { type:"checkbox", section:"Diferencial & Exclus√µes", text:"In√≠cio agudo com flutua√ß√£o e altera√ß√£o de consci√™ncia (delirium)", options: YNP },
  { type:"checkbox", section:"Diferencial & Exclus√µes", text:"Periparto/p√≥s-parto ou luto recente como contexto", options: YNP },

  // ‚Äî‚Äî‚Äî FUNCIONAMENTO GLOBAL ‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Funcionamento Global", text:"Queda de produtividade/atrasos/erros no trabalho/estudos", options: FREQ5 },
  { type:"checkbox", section:"Funcionamento Global", text:"Autocuidado prejudicado (higiene, alimenta√ß√£o, finan√ßas)", options: SEVER4 },
  { type:"checkbox", section:"Funcionamento Global", text:"Isolamento/conflitos significativos", options: FREQ5 },

  // ‚Äî‚Äî‚Äî RISCO & PROTE√á√ÉO ‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Risco & Prote√ß√£o", text:"Idea√ß√£o de morte/suicida em qualquer momento", options: YNP },
  { type:"checkbox", section:"Risco & Prote√ß√£o", text:"Acesso a meios letais (armas/estoque de medicamentos)", options: YNP },
  { type:"checkbox", section:"Risco & Prote√ß√£o", text:"Auto/heteroagressividade recente", options: YNP },
  { type:"checkbox", section:"Risco & Prote√ß√£o", text:"Rede de apoio ativa e estrat√©gias de autocuidado", options: YNP },

  // ‚Äî‚Äî‚Äî‚Äî‚Äî HUMOR & ANSIEDADE ‚Äî‚Äî‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Humor & Ansiedade", text:"Humor deprimido (triste/sem energia) na maior parte dos dias", options: FREQ5 },
  // (deduplicado) { type:"checkbox", section:"Humor & Ansiedade", text:"Perda de interesse/prazer (anedonia)", options: FREQ5 },
  { type:"checkbox", section:"Humor & Ansiedade", text:"Irritabilidade/pavio curto", options: FREQ5 },
  { type:"checkbox", section:"Humor & Ansiedade", text:"Preocupa√ß√£o excessiva/rumina√ß√£o dif√≠cil de controlar", options: FREQ5 },
  { type:"checkbox", section:"Humor & Ansiedade", text:"Sintomas f√≠sicos de ansiedade (taquicardia, sudorese, falta de ar)", options: FREQ5 },
  { type:"checkbox", section:"Humor & Ansiedade", text:"Crises de p√¢nico (in√≠cio s√∫bito, pico em minutos)", options: FREQ5 },
  { type:"checkbox", section:"Humor & Ansiedade", text:"Culpa excessiva por falhas pequenas", options: FREQ5 },

  // ‚Äî‚Äî‚Äî‚Äî‚Äî ATEN√á√ÉO & MEM√ìRIA ‚Äî‚Äî‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Aten√ß√£o & Mem√≥ria", text:"Dificuldade para manter a aten√ß√£o em tarefas/leituras", options: FREQ5 },
  { type:"checkbox", section:"Aten√ß√£o & Mem√≥ria", text:"Esquecimentos no dia a dia (compromissos, recados, objetos)", options: FREQ5 },
  { type:"checkbox", section:"Aten√ß√£o & Mem√≥ria", text:"Distrai-se com est√≠mulos externos/pensamentos", options: FREQ5 },
  { type:"checkbox", section:"Aten√ß√£o & Mem√≥ria", text:"Perde objetos com frequ√™ncia (chaves, carteira, celular)", options: FREQ5 },
  { type:"checkbox", section:"Aten√ß√£o & Mem√≥ria", text:"Hiperfoco prolongado em interesses espec√≠ficos", options: FREQ5 },

  // ‚Äî‚Äî‚Äî‚Äî‚Äî FUN√á√ïES EXECUTIVAS ‚Äî‚Äî‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Fun√ß√µes Executivas", text:"Procrastina√ß√£o (evita/adiar tarefas importantes)", options: FREQ5 },
  { type:"checkbox", section:"Fun√ß√µes Executivas", text:"Dificuldade para organizar materiais/rotina/prazos", options: FREQ5 },
  // (deduplicado) { type:"checkbox", section:"Fun√ß√µes Executivas", text:"Dificuldade para planejar tarefas em etapas", options: FREQ5 },
  { type:"checkbox", section:"Fun√ß√µes Executivas", text:"Age sem pensar (baixa inibi√ß√£o/impulsividade)", options: FREQ5 },
  { type:"checkbox", section:"Fun√ß√µes Executivas", text:"Dificuldade para tomar decis√µes (trava/evita escolher)", options: FREQ5 },

  // ‚Äî‚Äî‚Äî‚Äî‚Äî SONO ‚Äî‚Äî‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Sono", text:"Dificuldade para iniciar o sono", options: FREQ5 },
  { type:"checkbox", section:"Sono", text:"Acorda durante a noite ou muito cedo", options: FREQ5 },
  { type:"checkbox", section:"Sono", text:"Sono n√£o reparador (acorda cansado)", options: FREQ5 },
  { type:"checkbox", section:"Sono", text:"Sonol√™ncia diurna/excesso de cochilos", options: FREQ5 },
  { type:"checkbox", section:"Sono", text:"Sinais sugestivos de apneia (ronco/pausas respirat√≥rias observadas)", options: YNP },

  // ‚Äî‚Äî‚Äî‚Äî‚Äî ALIMENTA√á√ÉO & ENERGIA ‚Äî‚Äî‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Alimenta√ß√£o & Energia", text:"Oscila√ß√µes marcantes de apetite", options: FREQ5 },
  { type:"checkbox", section:"Alimenta√ß√£o & Energia", text:"Comer por impulso/compuls√£o alimentar", options: FREQ5 },
  // (deduplicado) { type:"checkbox", section:"Alimenta√ß√£o & Energia", text:"Insatisfa√ß√£o intensa com a imagem corporal", options: FREQ5 },
  { type:"checkbox", section:"Alimenta√ß√£o & Energia", text:"Uso de cafe√≠na/estimulantes para 'render'", options: FREQ5 },

  // ‚Äî‚Äî‚Äî‚Äî‚Äî TRABALHO & ESTUDO ‚Äî‚Äî‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Trabalho & Estudo", text:"Queda de produtividade/entregas irregulares", options: FREQ5 },
  { type:"checkbox", section:"Trabalho & Estudo", text:"Atrasos/aus√™ncias/descumprimento de prazos", options: FREQ5 },
  { type:"checkbox", section:"Trabalho & Estudo", text:"Feedbacks negativos por organiza√ß√£o/comunica√ß√£o", options: FREQ5 },
  { type:"checkbox", section:"Trabalho & Estudo", text:"Dificuldade para lidar com tarefas longas/mon√≥tonas", options: FREQ5 },

  // ‚Äî‚Äî‚Äî‚Äî‚Äî RELA√á√ïES & REDE DE APOIO ‚Äî‚Äî‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Rela√ß√µes & Rede de Apoio", text:"Conflitos frequentes com parceiros/fam√≠lia/colegas", options: FREQ5 },
  { type:"checkbox", section:"Rela√ß√µes & Rede de Apoio", text:"Dificuldade para manter amizades/contatos", options: FREQ5 },
  { type:"checkbox", section:"Rela√ß√µes & Rede de Apoio", text:"Depend√™ncia emocional/apoio excessivo de terceiros", options: YNP },
  { type:"checkbox", section:"Rela√ß√µes & Rede de Apoio", text:"Isolamento/evita situa√ß√µes sociais", options: FREQ5 },

  // ‚Äî‚Äî‚Äî‚Äî‚Äî LINGUAGEM & COMUNICA√á√ÉO ‚Äî‚Äî‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Linguagem & Comunica√ß√£o", text:"Evita falar em p√∫blico/reuni√µes", options: FREQ5 },
  { type:"checkbox", section:"Linguagem & Comunica√ß√£o", text:"Fala em excesso/atropela turnos de fala", options: FREQ5 },
  { type:"checkbox", section:"Linguagem & Comunica√ß√£o", text:"Perde o fio da conversa/esquece o que ia dizer", options: FREQ5 },
  { type:"checkbox", section:"Linguagem & Comunica√ß√£o", text:"Dificuldade para entender ironias/duplo sentido", options: FREQ5 },

  // ‚Äî‚Äî‚Äî‚Äî‚Äî COGNI√á√ÉO SOCIAL & FLEXIBILIDADE ‚Äî‚Äî‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Cogni√ß√£o Social & Flexibilidade", text:"Dificuldade para ler express√µes/inten√ß√µes alheias", options: FREQ5 },
  { type:"checkbox", section:"Cogni√ß√£o Social & Flexibilidade", text:"Rigidez a mudan√ßas/rotinas (sofre quando algo muda)", options: FREQ5 },
  { type:"checkbox", section:"Cogni√ß√£o Social & Flexibilidade", text:"Interesses intensos e restritos", options: FREQ5 },

  // ‚Äî‚Äî‚Äî‚Äî‚Äî SENSORIAL & MOTOR ‚Äî‚Äî‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Sensorial & Motor", text:"Sensibilidade incomum (som, luz, toque, cheiros, texturas)", options: FREQ5 },
  { type:"checkbox", section:"Sensorial & Motor", text:"Coordena√ß√£o motora/precis√£o manual prejudicada", options: SEVER4 },

  // ‚Äî‚Äî‚Äî‚Äî‚Äî SA√öDE F√çSICA & NEUROL√ìGICA ‚Äî‚Äî‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Sa√∫de F√≠sica & Neurol√≥gica", text:"Tonturas/s√≠ncopes/intoler√¢ncia ortost√°tica", options: YNP },
  { type:"checkbox", section:"Sa√∫de F√≠sica & Neurol√≥gica", text:"Hist√≥ria de TCE (trauma cranioencef√°lico) ou convuls√µes", options: YNP },
  { type:"checkbox", section:"Sa√∫de F√≠sica & Neurol√≥gica", text:"Condi√ß√µes cl√≠nicas ativas que impactam cogni√ß√£o (ex.: tireoide, dor cr√¥nica)", options: YNP },

  // ‚Äî‚Äî‚Äî‚Äî‚Äî SUBST√ÇNCIAS & COMPORTAMENTOS DE RISCO ‚Äî‚Äî‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Subst√¢ncias & Risco", text:"√Ålcool com preju√≠zo (perda de controle, ressacas, faltas)", options: YNP },
  { type:"checkbox", section:"Subst√¢ncias & Risco", text:"Cannabis com preju√≠zo funcional", options: YNP },
  { type:"checkbox", section:"Subst√¢ncias & Risco", text:"Estimulantes sem prescri√ß√£o/uso indevido de medica√ß√£o", options: YNP },
  { type:"checkbox", section:"Subst√¢ncias & Risco", text:"Sedativos/ansiol√≠ticos com uso problem√°tico", options: YNP },
  { type:"checkbox", section:"Subst√¢ncias & Risco", text:"Comportamentos de risco (tr√¢nsito, impulsos, apostas/compras)", options: FREQ5 },

  // ‚Äî‚Äî‚Äî‚Äî‚Äî PROTE√á√ÉO & RISCO ‚Äî‚Äî‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Prote√ß√£o & Risco", text:"Situa√ß√µes de viol√™ncia/abuso (sexual, f√≠sico, psicol√≥gico)", options: YNP },
  { type:"checkbox", section:"Prote√ß√£o & Risco", text:"Conflitos legais/disciplinar no trabalho/estudo", options: YNP },
  { type:"checkbox", section:"Prote√ß√£o & Risco", text:"Idea√ß√£o suicida ou autoagress√£o (em qualquer momento da vida)", options: YNP },

  // ‚Äî‚Äî‚Äî‚Äî‚Äî VIDA DOM√âSTICA & FINAN√áAS ‚Äî‚Äî‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Vida Dom√©stica & Finan√ßas", text:"Dificuldade para manter rotina dom√©stica/arruma√ß√£o", options: FREQ5 },
  { type:"checkbox", section:"Vida Dom√©stica & Finan√ßas", text:"Atraso de contas/organiza√ß√£o financeira fr√°gil", options: FREQ5 },
  { type:"checkbox", section:"Vida Dom√©stica & Finan√ßas", text:"Ac√∫mulo/dificuldade de descartar objetos", options: FREQ5 },

  // ‚Äî‚Äî‚Äî‚Äî‚Äî METAS & MOTIVA√á√ÉO ‚Äî‚Äî‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Metas & Motiva√ß√£o", text:"Clareza sobre objetivos pessoais/profissionais", options: SEVER4 }, // observa√ß√£o original mantida
  { type:"checkbox", section:"Metas & Motiva√ß√£o", text:"Motiva√ß√£o suficiente para iniciar/manter rotinas", options: FREQ5 },
  { type:"checkbox", section:"Metas & Motiva√ß√£o", text:"Evita tarefas desafiadoras por medo de falhar", options: FREQ5 },

  // ‚Äî‚Äî‚Äî‚Äî‚Äî TRATAMENTOS ANTERIORES ‚Äî‚Äî‚Äî‚Äî‚Äî
  { type:"checkbox", section:"Tratamentos Anteriores", text:"Psicoterapia pr√©via", options: YNP },
  { type:"checkbox", section:"Tratamentos Anteriores", text:"Uso atual ou pr√©vio de psicof√°rmacos", options: YNP },
  { type:"checkbox", section:"Tratamentos Anteriores", text:"Baixa ades√£o a tratamentos/abandonos frequentes", options: YNP },
  { type:"checkbox", section:"Tratamentos Anteriores", text:"Efeitos colaterais limitaram tratamentos anteriores", options: YNP }
];


const N = QUESTIONS.length;

// ======== RENDER ========
function renderQuestions(){
  const host = $("#qs"); 
  host.innerHTML = "";

  QUESTIONS.forEach((q, idx)=>{
    const n  = idx+1;
    const qn = String(n).padStart(2,"0");
    const wrap = document.createElement("div");
    wrap.className = "q";

    if (typeof q === "string") {
      // textarea ‚Äúlivre‚Äù
      wrap.innerHTML = `
        <h3 id="lbl${qn}">${n}. ${q}</h3>
        <textarea name="q${qn}" id="q${qn}" placeholder="Escreva aqui..."></textarea>
      `;
    } else if (q.type === "radio" || q.type === "checkbox") {
      // grupo de radios ou checkboxes
      const opts = q.options || [];
      let html = `<h3 id="lbl${qn}">${n}. ${q.text}</h3><div class="opts">`;
      opts.forEach((opt, i)=>{
        const id = `q${qn}_${i}`;
        html += `
          <label class="opt">
            <input type="${q.type}" name="q${qn}" id="${id}" value="${opt}">
            <span>${opt}</span>
          </label>`;
      });
      html += `</div>`;
      wrap.innerHTML = html;
    } else if (q.type === "input") {
      // campo de texto simples
      wrap.innerHTML = `
        <h3 id="lbl${qn}">${n}. ${q.text}</h3>
        <input type="text" name="q${qn}" id="q${qn}" class="field-input" />
      `;
    } else {
      // fallback, se aparecer algum tipo n√£o tratado
      wrap.innerHTML = `
        <h3 id="lbl${qn}">${n}. ${q.text || q}</h3>
        <textarea name="q${qn}" id="q${qn}" placeholder="Escreva aqui..."></textarea>
      `;
    }

    host.appendChild(wrap);
  });

  // autosize + progresso
  host.addEventListener("input", e=>{
    if(e.target.tagName==="TEXTAREA"){
      e.target.style.height="auto";
      e.target.style.height=(e.target.scrollHeight+2)+"px";
    }
    updateProg(); 
    autosaveAnswers();
  });
  host.addEventListener("change", ()=>{
    updateProg(); 
    autosaveAnswers();
  });

  updateProg();
}


function updateProg(){
  let filled = 0;

  QUESTIONS.forEach((q, idx)=>{
    const qn = `q${String(idx+1).padStart(2,"0")}`;

    if (typeof q === "string") {
      const el = $("#"+qn);
      if (el && el.value.trim()) filled++;

    } else if (q.type === "radio" || q.type === "checkbox") {
      const any = document.querySelectorAll(`input[name="${qn}"]:checked`).length > 0;
      if (any) filled++;

    } else if (q.type === "input") {
      const el = $("#"+qn);
      if (el && el.value.trim()) filled++;
    }
  });

  $("#progress").textContent = `${filled}/${N} respondidas`;
}

// ======== AUTOSAVE ========
function autosaveAnswers(){
  const answers  = {};
  const qaPairs  = [];
  let answeredCount = 0;

  QUESTIONS.forEach((q, idx)=>{
    const n  = idx+1;
    const qn = `q${String(n).padStart(2,"0")}`;
    const label = (typeof q === "string") ? q : (q.text || `Pergunta ${n}`);

    if (typeof q === "string") {
      // textarea
      const el  = $("#"+qn);
      const val = (el?.value || "").trim();
      answers[qn] = val;
      if (val) answeredCount++;
      qaPairs.push(`${n}. ${label}: ${val ? val.replace(/\s+/g," ").trim() : "(sem resposta)"}`);

    } else if (q.type === "radio") {
      // radio -> uma op√ß√£o (mas guardo como array pra manter padr√£o)
      const vals = Array.from(document.querySelectorAll(`input[name="${qn}"]:checked`)).map(el=>el.value);
      answers[qn] = vals;
      if (vals.length) answeredCount++;
      qaPairs.push(`${n}. ${label}: ${vals.length ? vals.join(", ") : "(nenhuma op√ß√£o marcada)"}`);

    } else if (q.type === "checkbox") {
      // checkboxes -> v√°rias op√ß√µes
      const vals = Array.from(document.querySelectorAll(`input[name="${qn}"]:checked`)).map(el=>el.value);
      answers[qn] = vals;
      if (vals.length) answeredCount++;
      qaPairs.push(`${n}. ${label}: ${vals.length ? vals.join(", ") : "(nenhuma op√ß√£o marcada)"}`);

    } else if (q.type === "input") {
      // input de texto simples
      const el  = $("#"+qn);
      const val = (el?.value || "").trim();
      answers[qn] = val;
      if (val) answeredCount++;
      qaPairs.push(`${n}. ${label}: ${val ? val.replace(/\s+/g," ").trim() : "(sem resposta)"}`);
    }
  });

  const categoria = qaPairs.join(" | ");

  localStorage.setItem(
    AUTOSAVE_KEY,
    JSON.stringify({ code: CODE, token: qs("token"), answers })
  );
}


function restoreAutosave(){
  try{
    const raw = localStorage.getItem(AUTOSAVE_KEY); 
    if(!raw) return;

    const {answers} = JSON.parse(raw) || {}; 
    if(!answers) return;

    Object.entries(answers).forEach(([key,val])=>{
      if (Array.isArray(val)) {
        // vale tanto pra radio quanto pra checkbox
        val.forEach(v=>{
          const el = document.querySelector(`input[name="${key}"][value="${v}"]`);
          if (el) el.checked = true;
        });
      } else {
        // textarea OU input
        const el = document.getElementById(key);
        if (el) {
          el.value = val;
          if (el.tagName === "TEXTAREA") {
            el.style.height = "auto";
            el.style.height = (el.scrollHeight+2)+"px";
          }
        }
      }
    });

    updateProg();
  }catch(_){}
}

function clearAutosave(){ localStorage.removeItem(AUTOSAVE_KEY); }

// ======== ESTADO ========
let patient=null, tokenRow=null, CPF="";
let startAt = Date.now();

// ======== BOOT POR TOKEN ========
(async function boot(){
  try{
    const TOKEN=qs("token");
    if(!TOKEN){ setBox("#alert","Link inv√°lido (sem token). Solicite um novo link.","err"); return; }

    const trows=await sheetSearch(SHEETS.TOKENS,{ token:TOKEN });
    if(!trows?.length) throw new Error("Token inv√°lido ou expirado.");
    tokenRow=trows[0];
    const disabled=String(tokenRow.disabled||"n√£o").toLowerCase()==="sim";
    const expired = tokenRow.expires_at && (Date.parse(tokenRow.expires_at) < Date.now());
    if(disabled || expired) throw new Error("Token desativado/expirado. Pe√ßa um novo link.");

    CPF=onlyDigits(tokenRow.cpf||""); if(!CPF) throw new Error("Token sem CPF vinculado.");

    const prows=await sheetSearch(SHEETS.PATIENTS,{ cpf:CPF });
    if(!prows?.length) throw new Error("Paciente n√£o encontrado.");
    patient=prows[0];

    const allowed=String(patient[CODE]||"").toLowerCase()==="sim";
    if(!allowed){ setBox("#alert","Este formul√°rio n√£o est√° liberado para voc√™. Entre em contato com o consult√≥rio.","err"); return; }

    const flagDone=String(patient[`${CODE}_FEITO`]||"").toLowerCase()==="sim";
    const already=await sheetSearch(SHEETS.SCORES,{ cpf:CPF, code:CODE });
    if(flagDone || (already && already.length)){
      setBox("#alert","Voc√™ j√° respondeu este formul√°rio. Voltando ao portal‚Ä¶","ok");
      setTimeout(goPortalWithToken,1200); return;
    }

    renderPatientInfo();
    renderQuestions();
    $("#pacInfo").style.display="grid";
    $("#form").style.display="block";
    hideBox("#alert");
    startAt=Date.now();
    restoreAutosave();

  }catch(err){
    console.error(err);
    setBox("#alert", err.message || "Falha ao abrir o formul√°rio. Tente novamente mais tarde.", "err");
  }
})();

function renderPatientInfo(){
  const g=$("#pacInfo"); g.innerHTML="";
  const info=[["Nome",patient.nome||"-"],["CPF",maskCPF(patient.cpf)],["Nascimento",fmtDateISO(patient.data_nascimento)],["E-mail",patient.email||"-"],["WhatsApp",patient.whatsapp||"-"]];
  for(const [k,v] of info){
    const d=document.createElement("div"); d.className="info";
    d.innerHTML=`<b>${k}</b><div>${v||"-"}</div>`;
    g.appendChild(d);
  }
}

// ======== SUBMIT ========
let sending=false;
$("#form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(sending) return; 
  sending=true; 
  hideBox("#msg");
  const btn=$("#btnSubmit"); 
  const originalText=btn.textContent; 
  btn.disabled=true; 
  btn.textContent="Enviando‚Ä¶";

  try{
    if(!patient) throw new Error("Sess√£o inv√°lida. Recarregue o link.");

    const answers = {};
    const qaPairs = [];
    let answeredCount = 0;

    for (let i=1; i<=N; i++){
      const q   = QUESTIONS[i-1];
      const qn  = `q${String(i).padStart(2,"0")}`;
      const label = (typeof q === "string") ? q : (q.text || `Pergunta ${i}`);

      if (typeof q === "string"){
        const el  = document.getElementById(qn);
        const val = (el?.value || "").trim();
        answers[qn] = val;
        if (val) answeredCount++;
        qaPairs.push(`${i}. ${label}: ${val ? val.replace(/\s+/g," ").trim() : "(sem resposta)"}`);

      } else if (q.type === "radio"){
        const checked = Array.from(document.querySelectorAll(`input[name="${qn}"]:checked`)).map(el=>el.value);
        answers[qn] = checked;
        if (checked.length) answeredCount++;
        qaPairs.push(`${i}. ${label}: ${checked.length ? checked.join(", ") : "(nenhuma op√ß√£o marcada)"}`);

      } else if (q.type === "checkbox"){
        const checked = Array.from(document.querySelectorAll(`input[name="${qn}"]:checked`)).map(el=>el.value);
        answers[qn] = checked;
        if (checked.length) answeredCount++;
        qaPairs.push(`${i}. ${label}: ${checked.length ? checked.join(", ") : "(nenhuma op√ß√£o marcada)"}`);

      } else if (q.type === "input"){
        const el  = document.getElementById(qn);
        const val = (el?.value || "").trim();
        answers[qn] = val;
        if (val) answeredCount++;
        qaPairs.push(`${i}. ${label}: ${val ? val.replace(/\s+/g," ").trim() : "(sem resposta)"}`);

      } else {
        qaPairs.push(`${i}. ${label}: (tipo n√£o suportado)`);
      }
    }

    // üî¥ AQUI ENTRA A TRAVA DE FORMUL√ÅRIO INCOMPLETO
    if (answeredCount < N) {
      sending = false;
      btn.disabled = false;
      btn.textContent = originalText;

      document.querySelectorAll(".q.missing").forEach(el => el.classList.remove("missing"));

      let firstMissingEl = null;

      QUESTIONS.forEach((q, idx) => {
        const n  = idx + 1;
        const qn = `q${String(n).padStart(2,"0")}`;
        let empty = false;

        if (typeof q === "string" || q.type === "input") {
          const el = document.getElementById(qn);
          empty = !el || !el.value.trim();
          if (empty && !firstMissingEl && el) {
            firstMissingEl = el.closest(".q") || el;
          }
        } else if (q.type === "radio" || q.type === "checkbox") {
          const hasChecked = document.querySelectorAll(`input[name="${qn}"]:checked`).length > 0;
          empty = !hasChecked;
          if (empty && !firstMissingEl) {
            const anyInput = document.querySelector(`input[name="${qn}"]`);
            if (anyInput) {
              firstMissingEl = anyInput.closest(".q") || anyInput;
            }
          }
        }

        if (empty) {
          const labelEl = document.getElementById(`lbl${String(n).padStart(2,"0")}`);
          const box = labelEl ? labelEl.closest(".q") : null;
          if (box) box.classList.add("missing");
        }
      });

      if (firstMissingEl) {
        firstMissingEl.scrollIntoView({ behavior: "smooth", block: "center" });
      }

      setBox(
        "#msg",
        `Voc√™ deixou ${N - answeredCount} quest√£o(√µes) sem responder. Complete todas antes de enviar.`,
        "err"
      );
      return;
    }

    // daqui pra baixo continua igual: anti-duplicidade, grava√ß√£o, PATCH, etc.
    const again = await sheetSearch(SHEETS.SCORES,{ cpf:CPF, code:CODE });
    if (again && again.length){
      setBox("#msg","Este formul√°rio j√° foi enviado anteriormente. Voltando ao portal‚Ä¶","ok");
      setTimeout(goPortalWithToken,1000);
      return;
    }

    const categoria = qaPairs.join(" | ");
    const durationSec = Math.round((Date.now()-startAt)/1000);

    const row = {
      result_id: `${patient.cpf}_${CODE}_${Date.now()}`,
      token: qs("token"),
      cpf: patient.cpf,
      code: CODE,
      source: "paciente",
      submitted_at: new Date().toISOString(),
      total: answeredCount,
      categoria,
      metrics: JSON.stringify({
        questions: QUESTIONS,
        answers,
        answeredCount,
        duration_sec: durationSec
      })
    };

    await sheetCreate(SHEETS.SCORES, row);
    await sheetPatchBy(SHEETS.PATIENTS, "cpf", patient.cpf, {
      [`${CODE}_FEITO`]: "sim",
      [`${CODE}_FEITO_AT`]: new Date().toISOString()
    });

    clearAutosave();
    setBox("#msg","Anamnese enviada. Retornando ao portal‚Ä¶","ok");
    setTimeout(goPortalWithToken, 1300);

  } catch(err){
    console.error(err);
    setBox("#msg", err.message || "Falha ao enviar. Tente novamente.", "err");
    sending=false; 
    btn.disabled=false; 
    btn.textContent=originalText;
  }
});


</script>
</body>
</html>
